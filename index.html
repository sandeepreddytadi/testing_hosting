<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Word Cloud - Firebase Native</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d3e 50%, #0f1b35 100%);
            min-height: 100vh;
            color: #ffffff;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00d9ff, #0099ff);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 217, 255, 0.4);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            font-weight: 500;
        }

        .screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #0099ff);
            color: white;
            box-shadow: 0 4px 20px rgba(0, 153, 255, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(0, 217, 255, 0.5);
        }

        .btn-primary:disabled {
            background: #2a2e4a;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #00d9ff;
            border: 2px solid rgba(0, 217, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(0, 217, 255, 0.1);
            border-color: #00d9ff;
        }

        .btn-ai {
            background: linear-gradient(135deg, #a742f5, #5e2be0);
            color: white;
            box-shadow: 0 4px 20px rgba(167, 66, 245, 0.3);
        }
        
        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(167, 66, 245, 0.5);
        }
        
        .btn-sheets {
            background: linear-gradient(135deg, #0f9d58, #0b8043);
            color: white;
            box-shadow: 0 4px 20px rgba(15, 157, 88, 0.3);
        }
        
        .btn-sheets:hover {
             transform: translateY(-2px);
             box-shadow: 0 6px 30px rgba(15, 157, 88, 0.5);
        }

        .card {
            background: rgba(20, 25, 50, 0.8);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 16px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .input-field {
            width: 100%;
            padding: 15px 20px;
            background: rgba(10, 14, 39, 0.6);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .input-field:focus {
            border-color: #00d9ff;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .cloud-container {
            position: relative;
            min-height: 450px;
            background: rgba(10, 14, 39, 0.4);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 50%;
            padding: 50px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 20px;
            box-shadow: inset 0 0 60px rgba(0, 217, 255, 0.1);
        }

        .word-item {
            font-weight: 700;
            color: #00d9ff;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
            animation: fadeIn 0.5s ease-out;
        }

        .word-item:hover {
            transform: scale(1.15);
            color: #00fff7;
            text-shadow: 0 0 20px rgba(0, 255, 247, 0.8);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .stat-badge {
            background: rgba(20, 25, 50, 0.9);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #00d9ff, #00fff7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-top: 8px;
        }

        .session-id {
            font-family: 'Courier New', monospace;
            font-size: 28px;
            color: #00d9ff;
            letter-spacing: 8px;
            text-align: center;
            padding: 20px;
            background: rgba(0, 217, 255, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(0, 217, 255, 0.3);
        }

        .hero-title {
            font-size: 56px;
            font-weight: 700;
            background: linear-gradient(135deg, #00d9ff 0%, #00fff7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 217, 255, 0.1);
            padding: 6px 16px;
            border-radius: 20px;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(0, 255, 136, 0);
            }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .word-tag {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            color: #00d9ff;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
            display: inline-block;
        }

        .excel-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 217, 255, 0.1);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(0, 217, 255, 0.3);
            font-size: 14px;
            margin-top: 10px;
        }
        
        .ai-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        .debug-footer {
            background: rgba(0,0,0,0.5);
            color: rgba(255,255,255,0.3);
            font-size: 10px;
            text-align: center;
            padding: 5px;
            margin-top: auto;
            font-family: monospace;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .hero-title { font-size: 36px; }
            .session-id { font-size: 20px; letter-spacing: 4px; }
            .cloud-container { border-radius: 40%; padding: 30px; }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    <div id="app"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        // Switching to version 10.8.0 for stability
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, initializeFirestore, persistentLocalCache, persistentMultipleTabManager } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // --- Custom Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyA1dAMbQ8xPDAO_2hkym7LOivHGYfg7k6Q",
            authDomain: "feedback-summarizer-36c66.firebaseapp.com",
            projectId: "feedback-summarizer-36c66",
            storageBucket: "feedback-summarizer-36c66.firebasestorage.app",
            messagingSenderId: "900418309044",
            appId: "1:900418309044:web:dc7317afbcdde4da0600e1",
            measurementId: "G-QH7BVZ2J8Q"
        };
        
        const appId = firebaseConfig.projectId;
        console.log("Using Config. App ID:", appId);

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        
        // Config with Persistence to handle flaky connections
        const db = initializeFirestore(firebaseApp, {
            localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
        });

        // --- Helper: Show Configuration Error Screen ---
        function showConfigError(title, message, steps) {
            const stepsHtml = steps.map(step => `<li>${step}</li>`).join('');
            document.getElementById('app').innerHTML = `
                <div class="screen" style="flex-direction:column; text-align:center; padding:20px;">
                    <h1 style="color:#ff4444; font-size:40px; margin-bottom: 20px;">‚ö†Ô∏è ${title}</h1>
                    <p style="font-size:18px; margin-bottom:30px;">${message}</p>
                    <div style="background:rgba(255,255,255,0.1); padding:30px; border-radius:12px; text-align:left; max-width: 600px;">
                        <strong style="font-size: 20px; color: #00d9ff; display: block; margin-bottom: 15px;">How to fix:</strong>
                        <ol style="margin-left:20px; line-height:1.8; font-size: 16px;">
                            ${stepsHtml}
                        </ol>
                    </div>
                    <button class="btn btn-secondary" onclick="location.reload()" style="margin-top:20px">Refresh Page</button>
                </div>
            `;
        }

        // --- Robust Auth System ---
        let authPromise = null;
        let currentUserUid = 'unknown';

        async function initAuth() {
            if (auth.currentUser) {
                currentUserUid = auth.currentUser.uid;
                return auth.currentUser;
            }
            if (authPromise) return authPromise;

            authPromise = new Promise(async (resolve, reject) => {
                try {
                    // Try Anonymous Auth
                    await signInAnonymously(auth);
                    console.log("Auth Success. User:", auth.currentUser.uid);
                    currentUserUid = auth.currentUser.uid;
                    renderDebug();
                    resolve(auth.currentUser);
                } catch (e) {
                    console.error("Auth Error:", e);
                    
                    if (e.code === 'auth/configuration-not-found' || e.code === 'auth/operation-not-allowed') {
                        showConfigError("Auth Configuration Error", "Firebase Authentication is not enabled.", [
                            `Go to <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/authentication" target="_blank" style="color:#00d9ff">Firebase Console > Authentication</a>`,
                            "Click <strong>Get Started</strong>",
                            "Go to <strong>Sign-in method</strong> tab",
                            "Enable <strong>Anonymous</strong> provider"
                        ]);
                    }
                    
                    reject(e);
                    authPromise = null;
                }
            });
            return authPromise;
        }

        // Initialize immediately
        initAuth().catch(e => console.error("Initial auth failed:", e));

        // Background
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 100; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.width = Math.random() * 3 + 'px';
            star.style.height = star.style.width;
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 3 + 's';
            starsContainer.appendChild(star);
        }

        // --- Cloud Storage (Direct JSON) ---
        const COLLECTION_NAME = 'word_cloud_sessions';
        let unsubscribe = null;

        const storage = {
            // Listen for changes
            listen(sessionId, callback) {
                if (unsubscribe) unsubscribe();
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, sessionId);
                    unsubscribe = onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            callback(docSnap.data());
                        }
                    }, (error) => {
                         console.error("Listener Error:", error);
                         if (error.code === 'permission-denied') {
                             notify('‚ö†Ô∏è DB Permission Denied: Check Firestore Rules');
                         }
                         if (error.message.includes("database (default) does not exist") || error.code === 'not-found') {
                             showConfigError("Database Not Found", "The Firestore Database has not been created yet.", [
                                 `Go to <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore" target="_blank" style="color:#00d9ff">Firebase Console > Firestore Database</a>`,
                                 "Click <strong>Create Database</strong>",
                                 "Choose a location (e.g. nam5)",
                                 "Select <strong>Start in Test Mode</strong> (for easy setup)",
                                 "Click <strong>Create</strong>"
                             ]);
                         }
                    });
                } catch(e) {
                    console.error("Listen error", e);
                }
            },

            // Check existence / Get once
            async get(sessionId) {
                await initAuth();
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, sessionId);
                    const snap = await getDoc(docRef); // This might fail if offline
                    if (snap.exists()) return snap.data();
                } catch (e) {
                    console.error('Storage Read Error:', e);
                    
                    if (e.message.includes("database (default) does not exist") || e.code === 'not-found') {
                         showConfigError("Database Not Found", "The Firestore Database has not been created yet.", [
                             `Go to <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore" target="_blank" style="color:#00d9ff">Firebase Console > Firestore Database</a>`,
                             "Click <strong>Create Database</strong>",
                             "Choose a location",
                             "Select <strong>Start in Test Mode</strong>",
                             "Click <strong>Create</strong>"
                         ]);
                         throw new Error("Database not configured"); // Stop execution
                    }

                    // Use catch block to handle offline gracefully
                    if (e.code === 'unavailable' || e.message.includes("offline")) {
                        throw new Error("You are offline. Please check connection.");
                    }
                    throw e; 
                }
                return null;
            },
            
            // Save Data
            async save(sessionId, data) {
                const user = await initAuth();
                if (!user) throw new Error("Not authenticated");

                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, sessionId);
                    await setDoc(docRef, {
                        ...data,
                        updatedAt: Date.now(),
                        lastUser: user.uid
                    }, { merge: true });
                } catch (e) {
                    console.error('Storage Write Error:', e);
                    
                    if (e.message.includes("database (default) does not exist") || e.code === 'not-found') {
                         showConfigError("Database Not Found", "The Firestore Database has not been created yet.", [
                             `Go to <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore" target="_blank" style="color:#00d9ff">Firebase Console > Firestore Database</a>`,
                             "Click <strong>Create Database</strong>",
                             "Choose a location",
                             "Select <strong>Start in Test Mode</strong>",
                             "Click <strong>Create</strong>"
                         ]);
                         throw new Error("Database not configured");
                    }

                    if (e.code === 'unavailable') {
                        // Offline persistence will eventually sync, so we don't throw hard error
                        console.log("Write queued offline");
                        return;
                    }
                    if (e.code === 'permission-denied') {
                        throw new Error("Database Permission Denied. Check Firestore Rules in Console.");
                    }
                    throw e; 
                }
            }
        };

        // App State
        let app = {
            mode: 'select',
            sessionId: '',
            sessionName: '',
            words: [],
            participants: 0,
            liveUsers: 0,
            summary: '',
            isGenerating: false,
            isSuggesting: false,
            isSubmitted: false,
            sheetUrl: 'https://docs.google.com/spreadsheets/d/1gA-KbxvpDxkr_nLp0bAHnPA0UdMoXjF-mpYLZYnr2h4/edit?usp=sharing'
        };

        // Utilities
        function notify(msg) {
            const n = document.createElement('div');
            n.className = 'notification';
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 5000); 
        }

        function speak(text) {
            try {
                speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.rate = 0.95;
                speechSynthesis.speak(u);
            } catch(e) {}
        }

        // --- Core Logic ---

        async function syncData() {
            if (!app.sessionId) return;
            
            const dataToSave = {
                sessionName: app.sessionName,
                words: app.words,
                summary: app.summary || ''
            };
            
            await storage.save(app.sessionId, dataToSave);
        }

        function onDataUpdate(data) {
            if (!data) return;
            if (data.words) app.words = data.words;
            if (data.sessionName) app.sessionName = data.sessionName;
            if (data.summary) app.summary = data.summary;
            render();
        }

        async function createSession() {
            try {
                notify("‚è≥ Initializing...");
                await initAuth();
                
                const name = prompt('Session Name:') || 'My Session';
                const id = Math.random().toString(36).substr(2, 6).toUpperCase();
                
                app.mode = 'host';
                app.sessionId = id;
                app.sessionName = name;
                app.words = [];
                render();
                
                notify("‚è≥ Saving to cloud...");
                await syncData(); 
                
                notify(`‚ú® Created: ${id}`);
                startRealtimeListener();
            } catch (e) {
                console.error("Session Creation Failed", e);
                // The explicit "not found" handler is inside storage.save, 
                // so here we just catch generic errors unless it's handled.
                if (!document.querySelector('.screen h1')?.innerText.includes("Error")) {
                     if (e.message.includes("Permission") || e.code === 'permission-denied') {
                        showConfigError("Database Locked", "Your Firestore Database security rules are blocking writes.", [
                             `Go to <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore/rules" target="_blank" style="color:#00d9ff">Firebase Console > Firestore > Rules</a>`,
                             "Change <code>allow read, write: if false;</code> to <strong><code>allow read, write: if true;</code></strong>",
                             "Click <strong>Publish</strong>",
                             "Reload this page"
                         ]);
                    } else if (e.message.includes("authenticated")) {
                        alert("AUTH ERROR: Not authenticated. Please reload.");
                        app.mode = 'select';
                        app.sessionId = '';
                        render();
                    } else if (!e.message.includes("Database not configured")) {
                        notify(`‚ùå Error: ${e.message || e}`);
                        app.mode = 'select';
                        app.sessionId = '';
                        render();
                    }
                }
            }
        }

        async function joinSession(id) {
            await initAuth();
            const clean = id.trim().toUpperCase();
            if (!clean) { notify('‚ùå Invalid ID'); return; }
            
            notify("‚è≥ Connecting...");
            
            try {
                // For joining, we rely on the listener directly if get() fails
                // due to offline status, but we try get() first for speed.
                const data = await storage.get(clean);
                
                if (data) {
                    app.sessionId = clean;
                    onDataUpdate(data);
                    app.mode = 'audience';
                    notify('‚ú® Connected');
                    startRealtimeListener();
                } else {
                    notify('‚ùå Session Not Found (Check Code)');
                }
            } catch (e) {
                if (e.message.includes("Database not configured")) return; // UI already handled

                // If get fails (e.g. offline), try listening anyway
                console.warn("Join Error, attempting fallback listener", e);
                app.sessionId = clean;
                startRealtimeListener();
                app.mode = 'audience'; // Assume success optimistically
                notify(`‚ö†Ô∏è Offline Mode: Waiting for sync...`);
            }
            render();
        }

        function startRealtimeListener() {
             if (!app.sessionId) return;
             storage.listen(app.sessionId, (data) => {
                 onDataUpdate(data);
             });
        }

        function stopListener() {
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
        }

        async function submitWord(word) {
            if (!word || !app.sessionId) return;
            // Optimistic update
            app.words.push({ 
                text: word.toLowerCase(), 
                timestamp: Date.now(), 
                id: Math.random().toString(36).substr(2, 9) 
            });
            
            try {
                await syncData();
                app.isSubmitted = true;
                notify('‚ú® Sent');
                render();
            } catch (e) {
                notify("‚ö†Ô∏è Saved locally (Offline)");
                app.isSubmitted = true; // Still show success UI
                render();
            }
        }

        // --- Features ---

        async function generateAI() {
            const apiKey = ""; 
            if (app.words.length === 0) return;
            
            app.isGenerating = true;
            render();
            
            try {
                const wordList = app.words.map(w => w.text).join(', ');
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Summarize the vibe of these words in 1 sentence: ${wordList}` }] }]
                    })
                });
                const data = await response.json();
                app.summary = data.candidates[0].content.parts[0].text;
                await syncData();
                speak(app.summary);
            } catch (e) {
                console.error(e);
                notify('‚ùå AI Failed');
            } finally {
                app.isGenerating = false;
                render();
            }
        }
        
        async function getGeminiSuggestion() {
            const apiKey = "";
            app.isSuggesting = true;
            render();
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Suggest ONE single word relevant to: "${app.sessionName}". No formatting.` }] }] })
                });
                const data = await response.json();
                const suggestion = data.candidates[0].content.parts[0].text.trim().replace(/[^a-zA-Z]/g, '');
                
                const input = document.getElementById('wordInput');
                if (input) { input.value = suggestion; input.dispatchEvent(new Event('input')); }
            } catch(e) { notify('‚ùå Suggestion Failed'); } 
            finally { app.isSuggesting = false; render(); }
        }

        // EXCEL EXPORT (On Demand Only)
        function downloadExcel() {
            if (app.words.length === 0) { notify('‚ùå No data'); return; }

            const submissionData = app.words.map((w, idx) => ({
                'Entry #': idx + 1,
                'Word': w.text,
                'Timestamp': new Date(w.timestamp).toLocaleString(),
                'ID': w.id
            }));

            const freq = {};
            app.words.forEach(w => freq[w.text] = (freq[w.text] || 0) + 1);
            const freqData = Object.entries(freq).sort((a, b) => b[1] - a[1])
                .map(([word, count], idx) => ({
                    'Rank': idx + 1, 'Word': word, 'Count': count
                }));

            const sessionInfo = [
                ['Session Name', app.sessionName],
                ['Session ID', app.sessionId],
                ['Total Words', app.words.length]
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sessionInfo), 'Info');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(submissionData), 'Data');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(freqData), 'Freq');

            if (app.summary) {
                const analysisWS = XLSX.utils.aoa_to_sheet([['AI Summary'], [app.summary]]);
                XLSX.utils.book_append_sheet(wb, analysisWS, 'AI');
            }

            XLSX.writeFile(wb, `WordCloud_${app.sessionId}.xlsx`);
            notify('üìä Downloaded');
        }

        function syncToSheets() {
             if (app.words.length === 0) { notify('‚ùå No data'); return; }

             const freq = {};
             app.words.forEach(w => freq[w.text] = (freq[w.text] || 0) + 1);
             const freqData = Object.entries(freq).sort((a, b) => b[1] - a[1]);

             let tsv = `SESSION REPORT\t\n`;
             tsv += `Session Name\t${app.sessionName}\n`;
             tsv += `Session ID\t${app.sessionId}\n`;
             tsv += `Total Words\t${app.words.length}\n`;
             if(app.summary) tsv += `AI Analysis\t${app.summary}\n`;
             tsv += `\n`;
             tsv += `RANK\tWORD\tCOUNT\n`;

             freqData.forEach(([word, count], idx) => {
                 tsv += `${idx + 1}\t${word}\t${count}\n`;
             });

             const textarea = document.createElement('textarea');
             textarea.value = tsv;
             document.body.appendChild(textarea);
             textarea.select();
             try { document.execCommand('copy'); } catch (e) {}
             document.body.removeChild(textarea);
             
             notify('üìã Data Copied! Opening Sheet...');
             setTimeout(() => {
                 window.open(app.sheetUrl, '_blank');
             }, 1000);
        }

        function renderDebug() {
            const el = document.getElementById('debug-info');
            if (el) {
                el.innerText = `App ID: ${appId} | Auth: ${currentUserUid.substr(0,5)}...`;
            }
        }

        function render() {
            const root = document.getElementById('app');
            
            if (app.mode === 'select') {
                root.innerHTML = `
                    <div class="screen">
                        <div style="text-align: center;">
                            <h1 class="hero-title">Cloud Word Cloud</h1>
                            <p style="opacity: 0.7; margin-bottom: 30px;">Real-time ‚Ä¢ Firebase ‚Ä¢ AI Powered</p>
                            <div class="grid-2">
                                <div class="card" onclick="createSession()" style="cursor: pointer;">
                                    <h2>üéØ Host</h2>
                                </div>
                                <div class="card">
                                    <h2>üöÄ Join</h2>
                                    <input id="joinInput" class="input-field" placeholder="CODE" style="text-align:center; margin: 10px 0;">
                                    <button id="joinBtn" class="btn btn-primary" style="width:100%">Connect</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    const btn = document.getElementById('joinBtn');
                    const inp = document.getElementById('joinInput');
                    if (btn && inp) btn.onclick = () => joinSession(inp.value);
                }, 50);
            
            } else if (app.mode === 'host' || app.mode === 'audience') {
                const freq = {};
                app.words.forEach(w => freq[w.text] = (freq[w.text] || 0) + 1);
                
                // Common Header
                let html = `
                    <div class="container">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h2>${app.sessionName} <span style="font-size:14px; opacity:0.5; font-family:monospace;">${app.sessionId}</span></h2>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                ${app.mode === 'host' ? `
                                    <button class="btn btn-ai" onclick="generateAI()" ${app.isGenerating?'disabled':''}>${app.isGenerating?'...':'‚ú® AI Summary'}</button>
                                    <button class="btn btn-sheets" onclick="syncToSheets()">üìà Sync to Sheets</button>
                                    <button class="btn btn-secondary" onclick="downloadExcel()">üì• Excel</button>
                                ` : ''}
                                <button class="btn btn-secondary" onclick="stopListener(); app.mode='select'; render()">Exit</button>
                            </div>
                        </div>
                `;

                // Content
                if (app.mode === 'host') {
                     html += `
                        <div class="card" style="margin-bottom:20px; min-height: 300px;">
                            <div class="cloud-container">
                                ${app.words.length === 0 ? 'Waiting for words...' : 
                                  Object.entries(freq).map(([txt, cnt]) => 
                                    `<span class="word-item" style="font-size:${Math.min(20+cnt*10, 80)}px">${txt}</span>`
                                  ).join('')}
                            </div>
                        </div>
                        ${app.summary ? `<div class="card"><h3>ü§ñ AI Insight</h3><p>${app.summary}</p></div>` : ''}
                     `;
                } else {
                    html += `
                        <div class="card" style="text-align:center; max-width:600px; margin:0 auto;">
                            ${!app.isSubmitted ? `
                                <h3>Send a word</h3>
                                <input id="wordInput" class="input-field" style="text-align:center; font-size:24px; margin: 20px 0;" maxlength="20">
                                <button class="btn btn-secondary" onclick="getGeminiSuggestion()" style="margin-bottom:20px; font-size:12px;">${app.isSuggesting?'...':'‚ú® Suggest'}</button>
                                <button id="submitBtn" class="btn btn-primary" style="width:100%">Submit</button>
                            ` : `
                                <h2 style="color:#00ff88; font-size:40px;">‚úì Sent</h2>
                                <button class="btn btn-secondary" onclick="app.isSubmitted=false; render()">Send Another</button>
                            `}
                        </div>
                        <div style="margin-top:30px;">
                            <h4>Live Feed (${app.words.length})</h4>
                            <div style="display:flex; flex-wrap:wrap; gap:10px;">
                                ${app.words.slice(-10).reverse().map(w => `<span class="word-tag">${w.text}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }

                html += `</div>`; // Close container
                root.innerHTML = html;

                if (app.mode === 'audience' && !app.isSubmitted) {
                    setTimeout(() => {
                        const btn = document.getElementById('submitBtn');
                        const inp = document.getElementById('wordInput');
                        if (btn && inp) btn.onclick = () => submitWord(inp.value);
                    }, 50);
                }
            }
            
            // Add Debug Footer
            if (!document.getElementById('debug-info')) {
                const footer = document.createElement('div');
                footer.id = 'debug-info';
                footer.className = 'debug-footer';
                document.body.appendChild(footer);
            }
            renderDebug();
        }

        // Expose to window
        window.createSession = createSession;
        window.joinSession = joinSession;
        window.submitWord = submitWord;
        window.stopListener = stopListener;
        window.generateAI = generateAI;
        window.getGeminiSuggestion = getGeminiSuggestion;
        window.downloadExcel = downloadExcel;
        window.syncToSheets = syncToSheets;
        
        window.render = render;
        window.app = app;
        
        render();
    </script>
</body>
</html>

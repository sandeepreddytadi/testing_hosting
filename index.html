<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interactive Word Cloud - Secure</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- ðŸ”´ IMPORTANT -->
<!-- QR LIB REMOVED ON PURPOSE -->

<style>
/* ===== YOUR ORIGINAL CSS â€” UNCHANGED ===== */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma}
body{
background:linear-gradient(135deg,#3656C4 0%,#C86DD7 100%);
color:#fff;min-height:100vh;overflow-x:hidden
}
.stars{position:fixed;inset:0;z-index:0;pointer-events:none}
.star{position:absolute;background:white;border-radius:50%;animation:twinkle 3s infinite}
@keyframes twinkle{0%,100%{opacity:.2}50%{opacity:1}}
.screen{min-height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column}
.container{max-width:1400px;margin:auto;padding:30px;position:relative;z-index:2}
.word-viz{height:500px;background:rgba(0,0,0,.25);border-radius:16px;position:relative;overflow:hidden}
.cloud-word{position:absolute;transform:translate(-50%,-50%);font-weight:700;white-space:nowrap}
.notification{position:fixed;top:20px;right:20px;background:#fff;color:#000;padding:12px 20px;border-radius:10px;font-weight:700;z-index:9999}
.btn{padding:12px 20px;border:none;border-radius:8px;font-weight:700;cursor:pointer}
.btn-primary{background:linear-gradient(90deg,#6a11cb,#2575fc);color:white}
.input{padding:14px;border-radius:8px;border:2px solid rgba(255,255,255,.3);background:rgba(0,0,0,.4);color:white;width:100%;margin:10px 0;text-align:center}
</style>
</head>

<body>
<div class="stars" id="stars"></div>
<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/* ===============================
   ðŸ”’ FIXED SESSION CONFIG
================================ */
const FIXED_SESSION_ID   = "LTC2025";
const FIXED_SESSION_NAME = "LTC Away Day";
const SESSION_PIN        = "7391";

/* ===============================
   FIREBASE CONFIG (UNCHANGED)
================================ */
const firebaseConfig = {
 apiKey: "AIzaSyA1dAMbQ8xPDAO_2hkym7LOivHGYfg7k6Q",
 authDomain: "feedback-summarizer-36c66.firebaseapp.com",
 projectId: "feedback-summarizer-36c66",
 storageBucket: "feedback-summarizer-36c66.firebasestorage.app",
 messagingSenderId: "900418309044",
 appId: "1:900418309044:web:dc7317afbcdde4da0600e1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
await signInAnonymously(auth);

const COLLECTION = "word_cloud_sessions";

/* ===============================
   STATE
================================ */
let state = {
 mode: "select", // select | host | audience
 words: [],
 summary: "",
 isModalOpen: false
};

let unsubscribe = null;

/* ===============================
   UTIL
================================ */
function notify(msg){
 const n=document.createElement("div");
 n.className="notification";
 n.innerText=msg;
 document.body.appendChild(n);
 setTimeout(()=>n.remove(),3000);
}

function pos(text){
 let h=0;
 for(let c of text) h=c.charCodeAt(0)+((h<<5)-h);
 return {x:10+Math.abs(h%80),y:10+Math.abs((h*7)%80)};
}

/* ===============================
   FIRESTORE
================================ */
function listen(){
 if(unsubscribe) unsubscribe();
 const ref=doc(db,COLLECTION,FIXED_SESSION_ID);
 unsubscribe=onSnapshot(ref,s=>{
   if(s.exists()){
     state.words=s.data().words||[];
     state.summary=s.data().summary||"";
     render();
   }
 });
}

async function save(){
 const ref=doc(db,COLLECTION,FIXED_SESSION_ID);
 await setDoc(ref,{
   sessionName:FIXED_SESSION_NAME,
   words:state.words,
   summary:state.summary,
   pin:SESSION_PIN
 },{merge:true});
}

/* ===============================
   HOST START (FIXED)
================================ */
window.createSession = async ()=>{
 state.mode="host";
 state.words=[];
 await save();
 listen();
 render();
 notify("Session started");
};

/* ===============================
   JOIN WITH PIN
================================ */
window.joinSession = async ()=>{
 const pin=prompt("Enter Session PIN:");
 if(!pin) return;

 const ref=doc(db,COLLECTION,FIXED_SESSION_ID);
 const snap=await getDoc(ref);

 if(!snap.exists()){notify("Session not active");return;}
 if(pin!==snap.data().pin){notify("Invalid PIN");return;}

 state.mode="audience";
 listen();
 render();
 notify("Joined securely");
};

/* ===============================
   SUBMIT WORD
================================ */
window.submitWord = async ()=>{
 const input=document.getElementById("wordInput");
 if(!input.value) return;
 state.words.push({text:input.value.toUpperCase(),time:Date.now()});
 input.value="";
 await save();
};

/* ===============================
   AI ANALYSIS (UNCHANGED)
================================ */
window.analyzeAI = async ()=>{
 if(state.words.length===0) return;
 const res=await fetch("/api/analyze",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({words:state.words.map(w=>w.text)})
 });
 const data=await res.json();
 state.summary=data.summary||"";
 state.isModalOpen=true;
 await save();
 render();
};

window.closeModal=()=>{state.isModalOpen=false;render();};

/* ===============================
   EXIT
================================ */
window.exitSession=()=>{
 if(unsubscribe) unsubscribe();
 state.mode="select";
 state.words=[];
 render();
};

/* ===============================
   RENDER
================================ */
function render(){
 const root=document.getElementById("app");

 if(state.mode==="select"){
 root.innerHTML=`
 <div class="screen">
   <h1>WORD CLOUD</h1>
   <button class="btn btn-primary" onclick="createSession()">START SESSION</button>
   <button class="btn btn-primary" style="margin-top:10px" onclick="joinSession()">JOIN SESSION</button>
 </div>`;
 }

 if(state.mode==="audience"){
 root.innerHTML=`
 <div class="screen">
   <h2>${FIXED_SESSION_NAME}</h2>
   <input id="wordInput" class="input" placeholder="ENTER WORD">
   <button class="btn btn-primary" onclick="submitWord()">SEND</button>
   <button class="btn" onclick="exitSession()">EXIT</button>
 </div>`;
 }

 if(state.mode==="host"){
 const freq={};
 state.words.forEach(w=>freq[w.text]=(freq[w.text]||0)+1);

 root.innerHTML=`
 <div class="container">
   <h2>${FIXED_SESSION_NAME} (HOST)</h2>
   <button class="btn" onclick="analyzeAI()">AI ANALYSIS</button>
   <button class="btn" onclick="exitSession()">EXIT</button>

   <div class="word-viz">
   ${Object.entries(freq).map(([t,c])=>{
     const p=pos(t);
     return `<span class="cloud-word" style="left:${p.x}%;top:${p.y}%;font-size:${1+c*.4}rem">${t}</span>`;
   }).join("")}
   </div>
 </div>

 ${state.isModalOpen?`
 <div class="screen" style="position:fixed;inset:0;background:rgba(0,0,0,.7)">
   <div style="background:#111;padding:30px;border-radius:16px">
     <h3>AI Insights</h3>
     <p>${state.summary}</p>
     <button class="btn" onclick="closeModal()">CLOSE</button>
   </div>
 </div>`:""}
 `;
 }
}

render();
</script>
</body>
</html>

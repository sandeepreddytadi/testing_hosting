<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Word Cloud - Realtime</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d3e 50%, #0f1b35 100%);
            min-height: 100vh;
            color: #ffffff;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00d9ff, #0099ff);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 217, 255, 0.4);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            font-weight: 500;
        }

        .screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #0099ff);
            color: white;
            box-shadow: 0 4px 20px rgba(0, 153, 255, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(0, 217, 255, 0.5);
        }

        .btn-primary:disabled {
            background: #2a2e4a;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #00d9ff;
            border: 2px solid rgba(0, 217, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(0, 217, 255, 0.1);
            border-color: #00d9ff;
        }

        .btn-ai {
            background: linear-gradient(135deg, #a742f5, #5e2be0);
            color: white;
            box-shadow: 0 4px 20px rgba(167, 66, 245, 0.3);
        }
        
        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(167, 66, 245, 0.5);
        }
        
        .btn-sheets {
            background: linear-gradient(135deg, #0f9d58, #0b8043);
            color: white;
            box-shadow: 0 4px 20px rgba(15, 157, 88, 0.3);
        }
        
        .btn-sheets:hover {
             transform: translateY(-2px);
             box-shadow: 0 6px 30px rgba(15, 157, 88, 0.5);
        }

        .card {
            background: rgba(20, 25, 50, 0.8);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 16px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .input-field {
            width: 100%;
            padding: 15px 20px;
            background: rgba(10, 14, 39, 0.6);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .input-field:focus {
            border-color: #00d9ff;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .cloud-container {
            position: relative;
            min-height: 450px;
            background: rgba(10, 14, 39, 0.4);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 50%;
            padding: 50px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 20px;
            box-shadow: inset 0 0 60px rgba(0, 217, 255, 0.1);
        }

        .word-item {
            font-weight: 700;
            color: #00d9ff;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
            animation: fadeIn 0.5s ease-out;
        }

        .word-item:hover {
            transform: scale(1.15);
            color: #00fff7;
            text-shadow: 0 0 20px rgba(0, 255, 247, 0.8);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .stat-badge {
            background: rgba(20, 25, 50, 0.9);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #00d9ff, #00fff7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-top: 8px;
        }

        .session-id {
            font-family: 'Courier New', monospace;
            font-size: 28px;
            color: #00d9ff;
            letter-spacing: 8px;
            text-align: center;
            padding: 20px;
            background: rgba(0, 217, 255, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(0, 217, 255, 0.3);
        }

        .hero-title {
            font-size: 56px;
            font-weight: 700;
            background: linear-gradient(135deg, #00d9ff 0%, #00fff7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 217, 255, 0.1);
            padding: 6px 16px;
            border-radius: 20px;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(0, 255, 136, 0);
            }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .word-tag {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            color: #00d9ff;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
            display: inline-block;
        }

        .excel-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 217, 255, 0.1);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(0, 217, 255, 0.3);
            font-size: 14px;
            margin-top: 10px;
        }
        
        /* Loading animation for AI */
        .ai-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        .debug-footer {
            background: rgba(0,0,0,0.5);
            color: rgba(255,255,255,0.3);
            font-size: 10px;
            text-align: center;
            padding: 5px;
            margin-top: auto;
            font-family: monospace;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .hero-title { font-size: 36px; }
            .session-id { font-size: 20px; letter-spacing: 4px; }
            .cloud-container { border-radius: 40%; padding: 30px; }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    <div id="app"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- Firebase Initialization ---
        const firebaseConfig = JSON.parse(__firebase_config || '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        console.log("App ID:", appId);

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        // Robust Auth System
        let authPromise = null;
        let currentUserUid = 'unknown';

        async function initAuth() {
            if (auth.currentUser) {
                currentUserUid = auth.currentUser.uid;
                return auth.currentUser;
            }
            if (authPromise) return authPromise;

            authPromise = new Promise(async (resolve, reject) => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Auth Success. User:", auth.currentUser.uid);
                    currentUserUid = auth.currentUser.uid;
                    renderDebug();
                    resolve(auth.currentUser);
                } catch (e) {
                    console.error("Auth Error:", e);
                    reject(e);
                    authPromise = null;
                }
            });
            return authPromise;
        }

        // Initialize immediately
        initAuth();

        // Create stars background
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 100; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.width = Math.random() * 3 + 'px';
            star.style.height = star.style.width;
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 3 + 's';
            starsContainer.appendChild(star);
        }

        // --- Cloud Storage System (Firestore) ---
        const COLLECTION_NAME = 'word_cloud_sessions';
        let unsubscribe = null;

        const storage = {
            // Listen for changes (Real-time)
            listen(sessionId, callback) {
                if (unsubscribe) unsubscribe(); // Clear existing listener
                
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, sessionId);
                    unsubscribe = onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            callback(docSnap.data().content);
                        } else {
                            console.log("Document does not exist yet.");
                        }
                    }, (error) => {
                        console.error("Listener Error:", error);
                        if (error.code === 'permission-denied') {
                            notify('‚ö†Ô∏è Access Denied: Check App ID match');
                        }
                    });
                } catch(e) {
                    console.error("Listen setup error", e);
                }
            },

            async get(key) {
                const user = await initAuth();
                if (!user) return null;

                const sessionId = key.replace('excel_', '');
                if (!sessionId) return null;

                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, sessionId);
                    console.log("Reading path:", docRef.path);
                    const snap = await getDoc(docRef);
                    if (snap.exists()) {
                        return { value: snap.data().content };
                    }
                } catch (e) {
                    console.error('Cloud Storage Read Error:', e);
                    if (e.code === 'permission-denied') {
                        // This usually means data doesn't exist AND we aren't allowed to see that it doesn't exist,
                        // OR we are on the wrong App ID.
                        console.warn("Permission denied. Ensure both users are on App ID:", appId);
                    }
                }
                return null;
            },
            
            async set(key, value) {
                const user = await initAuth();
                if (!user) return null;

                const sessionId = key.replace('excel_', '');
                if (!sessionId) return null;

                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, sessionId);
                    await setDoc(docRef, {
                        content: value,
                        updated: Date.now(),
                        lastUser: user.uid
                    }, { merge: true }); // Merge to avoid overwriting unrelated fields
                    return { value };
                } catch (e) {
                    console.error('Cloud Storage Write Error:', e);
                }
                return null;
            }
        };

        // App State
        let app = {
            mode: 'select',
            sessionId: '',
            sessionName: '',
            words: [],
            participants: 0,
            liveUsers: 0,
            summary: '',
            isGenerating: false,
            isSuggesting: false,
            isSubmitted: false,
            lastExcelUpdate: null,
            sheetUrl: 'https://docs.google.com/spreadsheets/d/1gA-KbxvpDxkr_nLp0bAHnPA0UdMoXjF-mpYLZYnr2h4/edit?usp=sharing'
        };

        // Utility Functions
        function notify(msg) {
            const n = document.createElement('div');
            n.className = 'notification';
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 3000);
        }

        function sound(freq, dur) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur/1000);
                osc.start();
                osc.stop(ctx.currentTime + dur/1000);
            } catch(e) {}
        }

        function speak(text) {
            try {
                speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.rate = 0.95;
                u.pitch = 1.05;
                speechSynthesis.speak(u);
            } catch(e) {}
        }

        // Logic Functions
        async function saveToExcel(triggerUpload = true) {
            if (!app.sessionId || app.words.length === 0) return;

            const submissionData = app.words.map((w, idx) => ({
                'Entry #': idx + 1,
                'Word': w.text,
                'Timestamp': new Date(w.timestamp).toLocaleString(),
                'ID': w.id
            }));

            const freq = {};
            app.words.forEach(w => freq[w.text] = (freq[w.text] || 0) + 1);
            const freqData = Object.entries(freq).sort((a, b) => b[1] - a[1])
                .map(([word, count], idx) => ({
                    'Rank': idx + 1, 'Word': word, 'Count': count
                }));

            const sessionInfo = [
                ['Session Name', app.sessionName],
                ['Session ID', app.sessionId],
                ['Total Words', app.words.length]
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sessionInfo), 'Info');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(submissionData), 'Data');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(freqData), 'Freq');

            if (app.summary) {
                const analysisWS = XLSX.utils.aoa_to_sheet([['AI Summary'], [app.summary]]);
                XLSX.utils.book_append_sheet(wb, analysisWS, 'AI');
            }

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'base64' });
            
            if (triggerUpload) {
                await storage.set(`excel_${app.sessionId}`, wbout);
            }
            
            app.lastExcelUpdate = new Date().toLocaleTimeString();
            return wbout;
        }

        async function downloadExcel() {
            const excelData = await saveToExcel(false); // Don't upload, just generate
            if (!excelData) { notify('‚ùå No data'); return; }

            const byteCharacters = atob(excelData);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) byteNumbers[i] = byteCharacters.charCodeAt(i);
            const blob = new Blob([new Uint8Array(byteNumbers)], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CloudSession_${app.sessionId}.xlsx`;
            a.click();
            URL.revokeObjectURL(url);
            notify('üìä Downloaded');
        }

        function syncToSheets() {
             if (app.words.length === 0) {
                 notify('‚ùå No data to sync');
                 return;
             }

             // 1. Calculate stats
             const freq = {};
             app.words.forEach(w => freq[w.text] = (freq[w.text] || 0) + 1);
             const freqData = Object.entries(freq).sort((a, b) => b[1] - a[1]);

             // 2. Build TSV (Tab Separated Values)
             let tsv = `SESSION REPORT\t\n`;
             tsv += `Session Name\t${app.sessionName}\n`;
             tsv += `Session ID\t${app.sessionId}\n`;
             tsv += `Total Words\t${app.words.length}\n`;
             if(app.summary) tsv += `AI Analysis\t${app.summary}\n`;
             tsv += `\n`;
             tsv += `RANK\tWORD\tCOUNT\n`;

             freqData.forEach(([word, count], idx) => {
                 tsv += `${idx + 1}\t${word}\t${count}\n`;
             });

             // 3. Copy to Clipboard
             copy(tsv);
             
             notify('üìã Data Copied! Opening Sheet...');
             setTimeout(() => {
                 window.open(app.sheetUrl, '_blank');
                 notify('üëâ Press Ctrl+V in the Sheet to paste');
             }, 1000);
        }

        function parseExcelData(base64) {
            try {
                const wb = XLSX.read(base64, { type: 'base64' });
                const submissionsSheet = wb.Sheets['Data'];
                if (submissionsSheet) {
                    const data = XLSX.utils.sheet_to_json(submissionsSheet);
                    app.words = data.map(row => ({
                        text: row['Word'],
                        timestamp: new Date(row['Timestamp']).getTime(),
                        id: row['ID']
                    }));
                    
                    const infoSheet = wb.Sheets['Info'];
                    const infoData = XLSX.utils.sheet_to_json(infoSheet, { header: 1 });
                    if(infoData[0] && infoData[0][1]) app.sessionName = infoData[0][1];
                    
                    // Check for AI summary
                    const aiSheet = wb.Sheets['AI'];
                    if (aiSheet) {
                         const aiData = XLSX.utils.sheet_to_json(aiSheet, { header: 1 });
                         if (aiData[1] && aiData[1][0]) app.summary = aiData[1][0];
                    }

                    render();
                }
            } catch (e) { console.error("Parse Error", e); }
        }

        async function createSession() {
            await initAuth();
            const name = prompt('Session Name:') || 'My Session';
            const id = Math.random().toString(36).substr(2, 6).toUpperCase();
            
            app.mode = 'host';
            app.sessionId = id;
            app.sessionName = name;
            app.words = [];
            
            await saveToExcel(true);
            notify(`‚ú® Created: ${id}`);
            
            // Start Realtime Listener for Host
            startRealtimeListener();
            render();
        }

        async function joinSession(id) {
            await initAuth();
            const clean = id.trim().toUpperCase();
            if (!clean) { notify('‚ùå Invalid ID'); return; }
            
            app.sessionId = clean;
            
            // Try initial fetch
            const result = await storage.get(`excel_${clean}`);
            
            if (result && result.value) {
                parseExcelData(result.value);
                app.mode = 'audience';
                notify('‚ú® Connected');
                startRealtimeListener(); // Audience also listens for updates (e.g. AI summary)
            } else {
                notify('‚ùå Session Not Found (Check App ID)');
            }
            render();
        }

        function startRealtimeListener() {
             if (!app.sessionId) return;
             storage.listen(app.sessionId, (base64) => {
                 parseExcelData(base64);
             });
        }

        function stopListener() {
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
        }

        async function submitWord(word) {
            if (!word || !app.sessionId) return;
            // Optimistic update
            app.words.push({ text: word.toLowerCase(), timestamp: Date.now(), id: Math.random().toString(36).substr(2, 9) });
            await saveToExcel(true);
            app.isSubmitted = true;
            notify('‚ú® Sent');
            render();
        }

        async function generateAI() {
            const apiKey = ""; 
            if (app.words.length === 0) return;
            
            app.isGenerating = true;
            render();
            
            try {
                const wordList = app.words.map(w => w.text).join(', ');
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Summarize the vibe of these words in 1 sentence: ${wordList}` }] }]
                    })
                });
                const data = await response.json();
                app.summary = data.candidates[0].content.parts[0].text;
                await saveToExcel(true); // Save summary to cloud
                speak(app.summary);
            } catch (e) {
                console.error(e);
                notify('‚ùå AI Failed');
            } finally {
                app.isGenerating = false;
                render();
            }
        }
        
        async function getGeminiSuggestion() {
            const apiKey = "";
            app.isSuggesting = true;
            render();
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Suggest ONE single word relevant to: "${app.sessionName}". No formatting.` }] }] })
                });
                const data = await response.json();
                const suggestion = data.candidates[0].content.parts[0].text.trim().replace(/[^a-zA-Z]/g, '');
                
                const input = document.getElementById('wordInput');
                if (input) { input.value = suggestion; input.dispatchEvent(new Event('input')); }
            } catch(e) { notify('‚ùå Suggestion Failed'); } 
            finally { app.isSuggesting = false; render(); }
        }

        function copy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Copy failed', err);
            }
            document.body.removeChild(textarea);
        }

        function renderDebug() {
            const el = document.getElementById('debug-info');
            if (el) {
                el.innerText = `App ID: ${appId} | Auth: ${currentUserUid.substr(0,5)}...`;
            }
        }

        function render() {
            const root = document.getElementById('app');
            
            if (app.mode === 'select') {
                root.innerHTML = `
                    <div class="screen">
                        <div style="text-align: center;">
                            <h1 class="hero-title">Cloud Word Cloud</h1>
                            <p style="opacity: 0.7; margin-bottom: 30px;">Real-time ‚Ä¢ Cloud Sync ‚Ä¢ AI Powered</p>
                            <div class="grid-2">
                                <div class="card" onclick="createSession()" style="cursor: pointer;">
                                    <h2>üéØ Host</h2>
                                </div>
                                <div class="card">
                                    <h2>üöÄ Join</h2>
                                    <input id="joinInput" class="input-field" placeholder="CODE" style="text-align:center; margin: 10px 0;">
                                    <button id="joinBtn" class="btn btn-primary" style="width:100%">Connect</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    const btn = document.getElementById('joinBtn');
                    const inp = document.getElementById('joinInput');
                    if (btn && inp) btn.onclick = () => joinSession(inp.value);
                }, 50);
            
            } else if (app.mode === 'host' || app.mode === 'audience') {
                const freq = {};
                app.words.forEach(w => freq[w.text] = (freq[w.text] || 0) + 1);
                
                // Common Header
                let html = `
                    <div class="container">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h2>${app.sessionName} <span style="font-size:14px; opacity:0.5; font-family:monospace;">${app.sessionId}</span></h2>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                ${app.mode === 'host' ? `
                                    <button class="btn btn-ai" onclick="generateAI()" ${app.isGenerating?'disabled':''}>${app.isGenerating?'...':'‚ú® AI Summary'}</button>
                                    <button class="btn btn-sheets" onclick="syncToSheets()">üìà Sync to Sheets</button>
                                    <button class="btn btn-secondary" onclick="downloadExcel()">üì• Excel</button>
                                ` : ''}
                                <button class="btn btn-secondary" onclick="stopListener(); app.mode='select'; render()">Exit</button>
                            </div>
                        </div>
                `;

                // Content
                if (app.mode === 'host') {
                     html += `
                        <div class="card" style="margin-bottom:20px; min-height: 300px;">
                            <div class="cloud-container">
                                ${app.words.length === 0 ? 'Waiting for words...' : 
                                  Object.entries(freq).map(([txt, cnt]) => 
                                    `<span class="word-item" style="font-size:${Math.min(20+cnt*10, 80)}px">${txt}</span>`
                                  ).join('')}
                            </div>
                        </div>
                        ${app.summary ? `<div class="card"><h3>ü§ñ AI Insight</h3><p>${app.summary}</p></div>` : ''}
                     `;
                } else {
                    html += `
                        <div class="card" style="text-align:center; max-width:600px; margin:0 auto;">
                            ${!app.isSubmitted ? `
                                <h3>Send a word</h3>
                                <input id="wordInput" class="input-field" style="text-align:center; font-size:24px; margin: 20px 0;" maxlength="20">
                                <button class="btn btn-secondary" onclick="getGeminiSuggestion()" style="margin-bottom:20px; font-size:12px;">${app.isSuggesting?'...':'‚ú® Suggest'}</button>
                                <button id="submitBtn" class="btn btn-primary" style="width:100%">Submit</button>
                            ` : `
                                <h2 style="color:#00ff88; font-size:40px;">‚úì Sent</h2>
                                <button class="btn btn-secondary" onclick="app.isSubmitted=false; render()">Send Another</button>
                            `}
                        </div>
                        <div style="margin-top:30px;">
                            <h4>Live Feed (${app.words.length})</h4>
                            <div style="display:flex; flex-wrap:wrap; gap:10px;">
                                ${app.words.slice(-10).reverse().map(w => `<span class="word-tag">${w.text}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }

                html += `</div>`; // Close container
                root.innerHTML = html;

                if (app.mode === 'audience' && !app.isSubmitted) {
                    setTimeout(() => {
                        const btn = document.getElementById('submitBtn');
                        const inp = document.getElementById('wordInput');
                        if (btn && inp) btn.onclick = () => submitWord(inp.value);
                    }, 50);
                }
            }
            
            // Add Debug Footer
            if (!document.getElementById('debug-info')) {
                const footer = document.createElement('div');
                footer.id = 'debug-info';
                footer.className = 'debug-footer';
                document.body.appendChild(footer);
            }
            renderDebug();
        }

        // Expose to window
        window.createSession = createSession;
        window.joinSession = joinSession;
        window.submitWord = submitWord;
        window.stopListener = stopListener;
        window.generateAI = generateAI;
        window.getGeminiSuggestion = getGeminiSuggestion;
        window.downloadExcel = downloadExcel;
        window.syncToSheets = syncToSheets;
        window.copy = copy;
        
        // Expose render and app
        window.render = render;
        window.app = app;
        
        render();
    </script>
</body>
</html>

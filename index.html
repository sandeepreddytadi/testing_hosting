<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Word Cloud</title>

    <!-- KEEP ALL YOUR ORIGINAL STYLES (UNCHANGED) -->
    <!-- (styles omitted here for brevity ‚Äì USE YOUR ORIGINAL STYLE BLOCK EXACTLY AS IS) -->
</head>

<body>
<div class="stars" id="stars"></div>
<div id="app"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

/* ===========================
   üîí FIXED SESSION CONFIG
=========================== */
const FIXED_SESSION_ID   = "LTC2025";
const FIXED_SESSION_NAME = "LTC Away Day";
const SESSION_PIN        = "7391";

/* ===========================
   FIREBASE CONFIG (UNCHANGED)
=========================== */
const firebaseConfig = {
    apiKey: "AIzaSyA1dAMbQ8xPDAO_2hkym7LOivHGYfg7k6Q",
    authDomain: "feedback-summarizer-36c66.firebaseapp.com",
    projectId: "feedback-summarizer-36c66",
    storageBucket: "feedback-summarizer-36c66.firebasestorage.app",
    messagingSenderId: "900418309044",
    appId: "1:900418309044:web:dc7317afbcdde4da0600e1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
await signInAnonymously(auth);

const COLLECTION_NAME = "word_cloud_sessions";

/* ===========================
   STATE (UNCHANGED)
=========================== */
let state = {
    mode: "select",
    sessionId: "",
    sessionName: "",
    words: [],
    summary: "",
    isGenerating: false,
    isModalOpen: false
};

let unsubscribe = null;

/* ===========================
   FIRESTORE LISTENER (UNCHANGED)
=========================== */
function startListening(id){
    if(unsubscribe) unsubscribe();
    const ref = doc(db, COLLECTION_NAME, id);
    unsubscribe = onSnapshot(ref, snap => {
        if(snap.exists()){
            const d = snap.data();
            state.words = d.words || [];
            state.sessionName = d.sessionName;
            state.summary = d.summary || "";
            render();
        }
    });
}

/* ===========================
   SAVE (UNCHANGED)
=========================== */
async function saveData(){
    const ref = doc(db, COLLECTION_NAME, FIXED_SESSION_ID);
    await setDoc(ref,{
        sessionName: FIXED_SESSION_NAME,
        words: state.words,
        summary: state.summary,
        pin: SESSION_PIN
    },{merge:true});
}

/* ===========================
   üîí FIXED SESSION HOST
=========================== */
window.createSession = async () => {
    state.sessionId   = FIXED_SESSION_ID;
    state.sessionName = FIXED_SESSION_NAME;
    state.mode        = "host";
    state.words       = [];

    const ref = doc(db, COLLECTION_NAME, FIXED_SESSION_ID);
    await setDoc(ref,{
        sessionName: FIXED_SESSION_NAME,
        words: [],
        pin: SESSION_PIN,
        createdAt: Date.now()
    });

    startListening(FIXED_SESSION_ID);
    render();
};

/* ===========================
   üîê PIN PROTECTED JOIN
=========================== */
window.joinSession = async (id) => {
    const pin = prompt("Enter Session PIN:");
    if(!pin) return;

    const ref = doc(db, COLLECTION_NAME, FIXED_SESSION_ID);
    const snap = await getDoc(ref);

    if(!snap.exists()){
        alert("Session not active");
        return;
    }

    if(pin !== snap.data().pin){
        alert("Invalid PIN");
        return;
    }

    state.sessionId   = FIXED_SESSION_ID;
    state.sessionName = snap.data().sessionName;
    state.mode        = "audience";

    startListening(FIXED_SESSION_ID);
    render();
};

/* ===========================
   SUBMIT WORD (UNCHANGED)
=========================== */
window.submitWord = async (word)=>{
    if(!word) return;
    state.words.push({text:word.toUpperCase(),time:Date.now()});
    await saveData();
};

/* ===========================
   AI ANALYSIS (UNCHANGED)
=========================== */
window.analyzeAI = async ()=>{
    if(state.words.length===0) return;
    state.isGenerating = true;
    render();

    const res = await fetch("/api/analyze",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({words:state.words.map(w=>w.text)})
    });

    const data = await res.json();
    state.summary = data.summary || "";
    state.isModalOpen = true;
    state.isGenerating = false;
    await saveData();
    render();
};

/* ===========================
   EXIT (UNCHANGED)
=========================== */
window.exitSession = ()=>{
    if(unsubscribe) unsubscribe();
    state.mode="select";
    state.words=[];
    render();
};

/* ===========================
   RENDER
   üëâ USE YOUR ORIGINAL render()
   üëâ ONLY REMOVE QR HTML BLOCK
=========================== */

/* ‚ö†Ô∏è IMPORTANT:
   In your HOST render HTML:
   ‚ùå REMOVE the QR section
   <div id="qrcode">...</div>
   and QR generation JS

   EVERYTHING ELSE REMAINS IDENTICAL
*/

render();
</script>
</body>
</html>
